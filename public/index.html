<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Space Sim</title>
  </head>
  <body>
    <script src="elm.js"></script>
    <script type="module">
      import VirtualAudioContext from "./elm-web-audio.js";

      const SETTINGS_STORAGE_KEY = "settings";

      const randomSeeds = new Uint32Array(1);

      crypto.getRandomValues(randomSeeds);

      const savedSettings = localStorage.getItem(SETTINGS_STORAGE_KEY) || null;

      const ctx = new AudioContext();
      const virtualCtx = new VirtualAudioContext(ctx);

      const app = Elm.Main.init({
        flags: {
          initialSeed: randomSeeds[0],
          settings:
            savedSettings === null ? savedSettings : JSON.parse(savedSettings),
        },
      });

      app.ports.saveSettings.subscribe(function (settings) {
        localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings));
      });

      app.ports.toWebAudio &&
        app.ports.toWebAudio.subscribe((nodes) => {
          virtualCtx.update(nodes);
        });
    </script>
  </body>
</html>
